<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pigeons Sessions</title>
  <style>
    :root{
      --bg: radial-gradient(circle at top, #0f172a 0%, #020617 55%);
      --panel: rgba(2,6,23,.28);
      --card: rgba(15,23,42,.55);
      --border: rgba(148,163,184,.18);
      --text: #e2e8f0;
      --muted:#94a3b8;
      --accent:#22c55e;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--text); font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; border-bottom:1px solid rgba(148,163,184,.12);
      background: rgba(2,6,23,.18); backdrop-filter: blur(6px);
    }
    header h1{ margin:0; font-size:1rem; letter-spacing:.02em }
    #search{
      background: rgba(2,6,23,.6); border:1px solid var(--border);
      color:var(--text); border-radius:.6rem; padding:.45rem .6rem; width:280px;
      outline:none;
    }
    #search:focus{ border-color: rgba(34,197,94,.6); box-shadow:0 0 0 2px rgba(34,197,94,.12) }

    .layout{
      display:grid; grid-template-columns: 280px 1fr; gap:14px;
      width:min(1200px, 100%); margin:14px auto; padding:0 12px;
    }
    aside{
      background: var(--panel); border:1px solid var(--border); border-radius:14px;
      padding:12px; height: calc(100vh - 120px); position:sticky; top:14px; overflow:auto;
    }
    .panel{
      background: var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    }
    h2{
      margin:0 0 8px; font-size:.9rem; color:var(--muted); text-transform:uppercase; letter-spacing:.08em;
    }

    .list{
      display:flex; flex-direction:column; gap:6px;
    }
    .item{
      background: var(--card); border:1px solid rgba(148,163,184,.12);
      border-radius:10px; padding:10px; cursor:pointer;
      display:flex; flex-direction:column; gap:4px;
    }
    .item:hover{ border-color: rgba(34,197,94,.5) }
    .date{ font-size:.75rem; color:var(--muted) }
    .title{ font-weight:600; font-size:.9rem }

    .grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:10px;
    }

    .empty{
      padding:10px; color:var(--muted); font-size:.9rem;
    }

    @media (max-width: 860px){
      .layout{ grid-template-columns: 1fr; }
      aside{ position:static; height:auto }
    }
  </style>
</head>
<body>
  <header>
    <h1>Pigeons Sessions</h1>
    <input id="search" type="text" placeholder="Search city/venue/dateâ€¦"/>
  </header>

  <div class="layout">
    <aside>
      <h2>Past shows</h2>
      <div id="pastList" class="list"></div>
    </aside>

    <main class="panel">
      <h2>Upcoming shows</h2>
      <div id="upcomingGrid" class="grid"></div>
      <div id="upcomingEmpty" class="empty" style="display:none">No upcoming matches.</div>
    </main>
  </div>

  <script>
    const pastList = document.getElementById('pastList');
    const upcomingGrid = document.getElementById('upcomingGrid');
    const upcomingEmpty = document.getElementById('upcomingEmpty');
    const search = document.getElementById('search');

    // parse "YYYY-MM-DD" from id like "2026-01-23-baltimore-md-soundstage-1"
    function parseDateFromId(id){
      const d = id.slice(0,10);
      if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
        const dt = new Date(d + 'T00:00:00');
        return isNaN(dt) ? null : dt;
      }
      return null;
    }
    function fmt(dt){
      try{
        return dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
      }catch{ return String(dt).slice(0,10); }
    }
    function matchesFilter(item, q){
      if(!q) return true;
      const s = (item.title + ' ' + item.id).toLowerCase();
      return s.includes(q.toLowerCase());
    }
    function itemEl(s){
      const dt = parseDateFromId(s.id);
      const div = document.createElement('div');
      div.className = 'item';
      div.onclick = () => location.href = `/session/${encodeURIComponent(s.id)}`;
      const d = document.createElement('div');
      d.className = 'date';
      d.textContent = dt ? fmt(dt) : 'No date';
      const t = document.createElement('div');
      t.className = 'title';
      t.textContent = s.title || s.id;
      div.appendChild(d); div.appendChild(t);
      return div;
    }

    let all = [];
    function render(){
      const q = search.value.trim();

      // split by date
      const today = new Date();
      today.setHours(0,0,0,0);

      const upcoming = [];
      const past = [];

      for (const s of all){
        if (!matchesFilter(s, q)) continue;
        const dt = parseDateFromId(s.id);
        if (dt && dt >= today) upcoming.push(s);
        else past.push(s);
      }

      // sort: upcoming asc by date, then title; past desc by date
      const safeDate = (s) => parseDateFromId(s.id)?.getTime() ?? 0;
      upcoming.sort((a,b)=> safeDate(a)-safeDate(b) || a.title.localeCompare(b.title));
      past.sort((a,b)=> safeDate(b)-safeDate(a) || a.title.localeCompare(b.title));

      // draw
      upcomingGrid.innerHTML = '';
      pastList.innerHTML = '';

      for (const s of upcoming) upcomingGrid.appendChild(itemEl(s));
      for (const s of past) pastList.appendChild(itemEl(s));

      upcomingEmpty.style.display = upcoming.length ? 'none' : 'block';
    }

    async function boot(){
      try{
        const res = await fetch('/sessions');
        const json = await res.json();
        // Expect: [{id, title}]
        all = Array.isArray(json) ? json : [];
      }catch(e){
        console.error('Failed to load sessions:', e);
        all = [];
      }
      render();
    }

    search.addEventListener('input', render);
    boot();
  </script>
</body>
</html>
