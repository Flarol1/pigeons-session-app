<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Session</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --page-bg: radial-gradient(circle at top, #0f172a 0%, #020617 55%);
      --panel: rgba(15, 23, 42, 0.55);
      --card: rgba(15, 23, 42, 0.7);
      --border: rgba(148, 163, 184, 0.25);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #22c55e;
      --danger: #ef4444;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--page-bg);
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 1.2rem;
    }
    /* top nav */
    nav {
      width: min(1100px, 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(2, 6, 23, 0.1);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      gap: .75rem;
    }
    nav a {
      color: var(--text);
      text-decoration: none;
      font-size: .8rem;
      opacity: .8;
    }
    nav a:hover {
      opacity: 1;
    }
    #sessionNameBox {
      width: min(1100px, 100%);
      background: linear-gradient(120deg, rgba(34, 197, 94, 0.35), rgba(15, 23, 42, 0.3));
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 1rem;
      padding: 0.9rem 1.1rem;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 12px 20px rgba(0, 0, 0, .15);
    }
    #values {
      width: min(1100px, 100%);
      background: rgba(2, 6, 23, 0.2);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(148, 163, 184, 0.05);
      border-radius: 1rem;
      padding: 1.3rem 1.2rem 1.5rem;
      box-shadow: 0 18px 24px rgba(0,0,0,.12);
    }
    #controlRow {
      display: flex;
      gap: .6rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      justify-content: space-between;
    }
    button {
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.35);
      color: var(--text);
      padding: .5rem .9rem;
      border-radius: .6rem;
      font-weight: 500;
      cursor: pointer;
    }
    button:hover {
      background: rgba(34, 197, 94, 0.25);
    }
    #clearButton {
      background: rgba(148, 163, 184, 0.05);
      border: 1px solid rgba(148, 163, 184, 0.16);
    }
    #wordsList {
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }
    .user-board {
      background: rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(148, 163, 184, 0.04);
      border-radius: .9rem;
      padding: .8rem .8rem 1rem;
      display: flex;
      flex-direction: column;
      gap: .8rem;
    }
    .user-board-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
    }
    .user-board-header h3 {
      margin: 0;
      font-size: .95rem;
    }
    .remove-user-btn {
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.45);
    }
    .slot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: .7rem;
    }
    .slot-card {
      background: rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(148, 163, 184, 0.08);
      border-radius: .7rem;
      padding: .5rem .5rem .7rem;
      display: flex;
      flex-direction: column;
      gap: .4rem;
      min-height: 120px;
    }
    .slot-card h4 {
      margin: 0;
      font-size: .75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    .slot-value {
      font-weight: 600;
      font-size: .9rem;
    }
    /* ðŸ‘‡ dark select */
    select {
      background: rgba(2, 6, 23, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.45);
      border-radius: .45rem;
      padding: .35rem .4rem;
      color: #e2e8f0;
      font-size: .8rem;
      outline: none;
    }
    select:focus {
      border-color: rgba(34, 197, 94, 0.7);
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.12);
    }
    select option {
      background: #0f172a;
      color: #e2e8f0;
    }
    @media (max-width: 600px) {
      nav {
        flex-wrap: wrap;
        justify-content: center;
      }
      body {
        padding: .7rem;
      }
    }
  </style>
</head>
<body>
  <nav>
    <div>Pigeons Session</div>
    <a href="/">Back to dates</a>
  </nav>

  <div id="sessionNameBox">Loading sessionâ€¦</div>

  <div id="values">
    <div id="controlRow">
      <div style="font-size:.7rem; opacity:.6;">
        Pick songs from the dropdowns â€” it saves automatically.
      </div>
      <button id="clearButton">Clear All</button>
    </div>
    <div id="wordsList"></div>
  </div>

  <script>
    const sessionId = decodeURIComponent(
      window.location.pathname.split('/').pop().trim()
    );
    const socket = io();

    let username = localStorage.getItem('setlist-username');
    if (!username) {
      username = prompt("Enter your name:") || `User-${Math.floor(Math.random() * 1000)}`;
      localStorage.setItem('setlist-username', username);
    }

    document.getElementById('sessionNameBox').textContent =
      `Session: ${sessionId} â€¢ you are ${username}`;

    socket.emit('join', { sessionId, username });

    const SONG_SLOTS = [
      "Opener",
      "Song 2",
      "Song 3",
      "Song 4",
      "Song 5",
      "Encore",
      "Cover",
      "Bustout"
    ];

    // short list for demo â€” you can swap back your full list
    const SONG_LIBRARY = [
     "Stay","Funk E Zekial","Landing","French Cafe","Overtired","Totally","On the Rise","Couldn't We All",
      "F.U.","Melting Lights","Julia","Schwanthem","Zydeko","Time To Ride","Sunny Day","Moonwalk","Horizon",
      "Lightning","White Night","Live Life","Upfunk","Live It Up","Walk Outside","Burning Up My Time",
      "Condenser","Fade Fast","Pop Off","Bad For You","Whoopie","Kiwi","Interzood","Penguins","Fun in Funk",
      "Somethin' for Ya","Ocean Flows","The Liquid","Porcupine","Henrietta","Too Long","Doc","Fox and Toad",
      "Offshoot","Posideon","King Kong","Dawn a New Day","High as Five","Sail On","Avalanche","Fortress",
      "Yo Soy Fiesta","Overrun","Havana","Snake Eyes","Skipjack","Elephante","Move Like That","Lost in Line",
      "Sir Real","Water","Lowdown","Su Casa","Distant Times","Paperboy","Whirled","Beanstalk","Indiglo",
      "The Town","Alright Tonight","Day In Time","My Own Way","Fall In Place","Skinner","Beneath The Surface",
      "Let The Boogie Out","Overtime","Sorcerer","Feelin' Fine","Yesterday In Time","Calm Before the Storm",
      "Underworld","Right Track","Hell Yeah","In the Bubble","Feed The Fire","Hit the Ground Runnin'",
      "Fantasy","Twitch","Mine","Donkey Hotel","Undivided","Melting Lights - live","Whirled - live",
      "Day in Time - live","Feet On The Ground - live","Bloodshot Rose","Blue Light","Cliffs","Dome People",
      "Drunk People","Dutchmaster","E Funk","Feet on the GRound","Funkijam","Go With it","Hell Yeah",
      "In the Bubble","J-Town","Miyagi","Montreal","Philosophy","Puddles","Say Cheese","Show Me","Spaced",
      "Spacejam","Steal the Shade","The Hop","The Labrynth","The Switch","The Turn","This is that","Too Long",
      "Treat Yourself","Weightless","Where Are We Going?","Winters Splinters","Wireless","New Song"
    ].sort((a,b) => a.localeCompare(b));

    function renderGrid(session) {
      const container = document.getElementById('wordsList');
      container.innerHTML = '';

      const users = session.users || [];
      const sessionOwner = session.owner;

      users.forEach(userObj => {
        const boardUser = userObj.username;
        const isMyBoard = boardUser === username;
        const iAmOwner = username === sessionOwner;

        const board = document.createElement('div');
        board.className = 'user-board';

        // header
        const header = document.createElement('div');
        header.className = 'user-board-header';

        const h3 = document.createElement('h3');
        h3.textContent = boardUser + (boardUser === sessionOwner ? ' (owner)' : '');
        header.appendChild(h3);

        if (iAmOwner && boardUser !== sessionOwner) {
          const rmBtn = document.createElement('button');
          rmBtn.textContent = 'Remove user';
          rmBtn.className = 'remove-user-btn';
          rmBtn.onclick = () => {
            if (!confirm(`Remove ${boardUser}'s board from this session?`)) return;
            socket.emit('delete-user-board', {
              sessionId,
              targetUsername: boardUser
            });
          };
          header.appendChild(rmBtn);
        }

        board.appendChild(header);

        // grid
        const grid = document.createElement('div');
        grid.className = 'slot-grid';

        SONG_SLOTS.forEach(slot => {
          const card = document.createElement('div');
          card.className = 'slot-card';

          const title = document.createElement('h4');
          title.textContent = slot;
          card.appendChild(title);

          const currentVal =
            session.userSongs &&
            session.userSongs[boardUser] &&
            session.userSongs[boardUser][slot];

          const value = document.createElement('div');
          value.className = 'slot-value';
          value.textContent = currentVal ? currentVal : 'â€”';
          card.appendChild(value);

          // only my board gets the select
          if (isMyBoard) {
            const select = document.createElement('select');

            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Choose song...';
            placeholder.disabled = true;
            if (!currentVal) placeholder.selected = true;
            select.appendChild(placeholder);

            SONG_LIBRARY.forEach(song => {
              const opt = document.createElement('option');
              opt.value = song;
              opt.textContent = song;
              if (currentVal && currentVal === song) {
                opt.selected = true;
              }
              select.appendChild(opt);
            });

            select.addEventListener('change', () => {
              const chosen = select.value;
              if (!chosen) return;
              socket.emit('set-song', {
                sessionId,
                slot,
                value: chosen,
                username
              });
            });

            card.appendChild(select);
          }

          grid.appendChild(card);
        });

        board.appendChild(grid);
        container.appendChild(board);
      });
    }

    socket.on('update-session', (session) => {
      renderGrid(session);
    });

    document.getElementById('clearButton').addEventListener('click', () => {
      socket.emit('clear-all', { sessionId });
    });

    socket.on('error', (msg) => {
      alert(msg);
    });
  </script>
</body>
</html>
