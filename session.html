<script>
  const sessionId = decodeURIComponent(
    window.location.pathname.split('/').pop().trim()
  );
  const socket = io();

  let username = localStorage.getItem('setlist-username');

  const SONG_SLOTS = [
    "Opener",
    "Song 2",
    "Song 3",
    "Song 4",
    "Song 5",
    "Song 6",
    "Encore",
    "Cover",
    "Bustout"
  ];

  // =========================
  // Songs (dynamic from /songs)
  // =========================
  let SONG_LIBRARY = [];
  let lastSessionState = null;

  async function loadSongs() {
    try {
      const res = await fetch('/songs', { cache: 'no-store' });
      if (!res.ok) throw new Error(`GET /songs HTTP ${res.status}`);
      const data = await res.json();
      SONG_LIBRARY = Array.isArray(data.songs) ? data.songs : [];
      SONG_LIBRARY.sort((a, b) => a.localeCompare(b));
      console.log('[songs] loaded:', SONG_LIBRARY.length);
    } catch (e) {
      console.error('[songs] load failed:', e);
      SONG_LIBRARY = [];
    }
  }

  function setSessionHeader(text) {
    const box = document.getElementById('sessionNameBox');
    box.innerHTML = `<span class="session-title">${text}</span>`;
  }

  // =========================
  // Name modal / login
  // =========================
  async function finishLogin(name) {
    username = String(name || '').trim();
    if (!username) return;

    localStorage.setItem('setlist-username', username);
    setSessionHeader(`Session: ${sessionId} • you are ${username}`);

    document.getElementById('nameOverlay').style.display = 'none';

    // Ensure songs are loaded before first grid render
    await loadSongs();

    socket.emit('join', { sessionId, username });
  }

  if (username) {
    setSessionHeader(`Session: ${sessionId} • you are ${username}`);
    document.getElementById('nameOverlay').style.display = 'none';

    (async () => {
      await loadSongs();
      socket.emit('join', { sessionId, username });
    })();
  } else {
    const btn = document.getElementById('nameSubmit');
    const input = document.getElementById('nameInput');

    btn.addEventListener('click', () => finishLogin(input.value));
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') finishLogin(input.value);
    });
  }

  // =========================
  // Render session grid
  // =========================
  function renderGrid(session) {
    const container = document.getElementById('wordsList');
    container.innerHTML = '';

    const users = session.users || [];

    users.forEach(userObj => {
      const boardUser = userObj.username;
      const isMyBoard = boardUser === username;

      const board = document.createElement('div');
      board.className = 'user-board';

      // header
      const header = document.createElement('div');
      header.className = 'user-board-header';

      const h3 = document.createElement('h3');
      h3.textContent = boardUser;
      header.appendChild(h3);

      board.appendChild(header);

      // grid
      const grid = document.createElement('div');
      grid.className = 'slot-grid';

      SONG_SLOTS.forEach(slot => {
        const card = document.createElement('div');
        card.className = 'slot-card';

        const title = document.createElement('h4');
        title.textContent = slot;
        card.appendChild(title);

        const currentVal =
          session.userSongs &&
          session.userSongs[boardUser] &&
          session.userSongs[boardUser][slot];

        const value = document.createElement('div');
        value.className = 'slot-value';
        value.textContent = currentVal ? currentVal : '—';
        card.appendChild(value);

        // only my board gets the picker
        if (isMyBoard) {
          const controlWrap = document.createElement('div');
          controlWrap.style.display = 'flex';
          controlWrap.style.flexDirection = 'column';
          controlWrap.style.gap = '.4rem';

          const isCustom = !!currentVal && !SONG_LIBRARY.includes(currentVal);

          const select = document.createElement('select');

          if (SONG_LIBRARY.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'No songs loaded (check /songs)';
            opt.disabled = true;
            opt.selected = true;
            select.appendChild(opt);
          } else {
            const optCustom = document.createElement('option');
            optCustom.value = '__CUSTOM__';
            optCustom.textContent = '— Type your own —';
            select.appendChild(optCustom);

            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Choose song...';
            placeholder.disabled = true;
            select.appendChild(placeholder);

            SONG_LIBRARY.forEach(song => {
              const opt = document.createElement('option');
              opt.value = song;
              opt.textContent = song;
              select.appendChild(opt);
            });

            if (isCustom) select.value = '__CUSTOM__';
            else if (currentVal) select.value = currentVal;
            else select.value = '';
          }

          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'inline-input';
          input.placeholder = 'Type a song...';
          input.value = isCustom ? currentVal : '';
          input.style.display = (select.value === '__CUSTOM__') ? 'block' : 'none';

          const backBtn = document.createElement('button');
          backBtn.textContent = 'Use dropdown';
          backBtn.className = 'btn-muted';
          backBtn.style.padding = '2px 6px';
          backBtn.style.fontSize = '.75rem';
          backBtn.style.width = 'fit-content';
          backBtn.style.display = (select.value === '__CUSTOM__') ? 'inline-block' : 'none';

          select.addEventListener('change', () => {
            if (select.value === '__CUSTOM__') {
              input.style.display = 'block';
              backBtn.style.display = 'inline-block';
              input.focus();
            } else if (select.value) {
              input.style.display = 'none';
              backBtn.style.display = 'none';
              socket.emit('set-song', { sessionId, slot, value: select.value });
            }
          });

          const saveCustom = () => {
            const val = input.value.trim();
            if (!val) return;
            socket.emit('set-song', { sessionId, slot, value: val });
          };
          input.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveCustom(); });
          input.addEventListener('blur', saveCustom);

          backBtn.addEventListener('click', () => {
            input.style.display = 'none';
            backBtn.style.display = 'none';
            select.value = '';
            select.focus();
          });

          controlWrap.appendChild(select);
          controlWrap.appendChild(input);
          controlWrap.appendChild(backBtn);
          card.appendChild(controlWrap);
        }

        grid.appendChild(card);
      });

      board.appendChild(grid);
      container.appendChild(board);
    });
  }

  socket.on('update-session', (session) => {
    lastSessionState = session;
    renderGrid(session);
  });

  socket.on('error', (msg) => alert(msg));

  document.getElementById('clearButton').addEventListener('click', () => {
    socket.emit('clear-all', { sessionId });
  });

  document.getElementById('refreshSongsBtn').addEventListener('click', async () => {
    await loadSongs();
    if (lastSessionState) renderGrid(lastSessionState);
  });

  // =========================
  // Song List modal (view + edit)
  // =========================
  const songListBtn = document.getElementById('songListBtn');
  const songsOverlay = document.getElementById('songsOverlay');
  const songsCloseBtn = document.getElementById('songsCloseBtn');
  const songsEditBtn = document.getElementById('songsEditBtn');
  const songsSearch = document.getElementById('songsSearch');
  const songsList = document.getElementById('songsList');
  const songsAdminBadge = document.getElementById('songsAdminBadge');
  const songsEditPanel = document.getElementById('songsEditPanel');
  const songsAddInput = document.getElementById('songsAddInput');
  const songsAddBtn = document.getElementById('songsAddBtn');
  const songsLogoutBtn = document.getElementById('songsLogoutBtn');

  let songsEditMode = (sessionStorage.getItem('songs-edit') === '1');

  function checkSongPassword(input) {
    const v = String(input || '').trim().toLowerCase();
    return v === 'zaq' || v === 'zack';
  }

  function setEditMode(on) {
    songsEditMode = !!on;
    sessionStorage.setItem('songs-edit', songsEditMode ? '1' : '0');

    songsEditPanel.style.display = songsEditMode ? 'block' : 'none';
    songsAdminBadge.textContent = songsEditMode ? 'Editing enabled' : 'View only';
    songsEditBtn.textContent = songsEditMode ? 'Editing ✓' : 'Edit';

    renderSongsList();
  }

  function openSongsModal() {
    songsOverlay.style.display = 'flex';
    songsSearch.value = '';
    renderSongsList();
    // refresh list from server each open
    (async () => {
      await loadSongs();
      renderSongsList();
      // also refresh dropdowns if you're currently on a session
      if (lastSessionState) renderGrid(lastSessionState);
    })();
  }

  function closeSongsModal() {
    songsOverlay.style.display = 'none';
  }

  function renderSongsList() {
    const q = String(songsSearch.value || '').trim().toLowerCase();
    const filtered = q
      ? SONG_LIBRARY.filter(s => String(s).toLowerCase().includes(q))
      : SONG_LIBRARY;

    songsList.innerHTML = '';

    if (!filtered.length) {
      const empty = document.createElement('div');
      empty.style.opacity = '.7';
      empty.style.fontSize = '.85rem';
      empty.textContent = q ? 'No matches.' : 'No songs found.';
      songsList.appendChild(empty);
      return;
    }

    filtered.forEach(name => {
      const row = document.createElement('div');
      row.className = 'song-row';

      const label = document.createElement('div');
      label.className = 'song-name';
      label.textContent = name;
      row.appendChild(label);

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '.4rem';

      if (songsEditMode) {
        const del = document.createElement('button');
        del.textContent = 'Delete';
        del.className = 'btn-danger';
        del.onclick = async () => {
          if (!confirm(`Delete "${name}"?`)) return;
          await deleteSong(name);
        };
        actions.appendChild(del);
      }

      row.appendChild(actions);
      songsList.appendChild(row);
    });
  }

  async function addSong(name) {
    const clean = String(name || '').trim();
    if (!clean) return;

    try {
      const res = await fetch('/songs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: clean })
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || `HTTP ${res.status}`);
      }

      songsAddInput.value = '';
      await loadSongs();
      renderSongsList();
      if (lastSessionState) renderGrid(lastSessionState);
    } catch (e) {
      console.error(e);
      alert('Add failed: ' + e.message);
    }
  }

  async function deleteSong(name) {
    try {
      const res = await fetch('/songs', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || `HTTP ${res.status}`);
      }

      await loadSongs();
      renderSongsList();
      if (lastSessionState) renderGrid(lastSessionState);
    } catch (e) {
      console.error(e);
      alert('Delete failed: ' + e.message);
    }
  }

  // Hook up modal buttons
  songListBtn.addEventListener('click', openSongsModal);
  songsCloseBtn.addEventListener('click', closeSongsModal);

  songsOverlay.addEventListener('click', (e) => {
    if (e.target === songsOverlay) closeSongsModal();
  });

  songsSearch.addEventListener('input', renderSongsList);

  songsEditBtn.addEventListener('click', () => {
    if (songsEditMode) {
      setEditMode(false);
      return;
    }
    const pw = prompt('Enter edit password:');
    if (!checkSongPassword(pw)) {
      alert('Nope.');
      return;
    }
    setEditMode(true);
  });

  songsLogoutBtn.addEventListener('click', () => setEditMode(false));

  songsAddBtn.addEventListener('click', () => addSong(songsAddInput.value));
  songsAddInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') addSong(songsAddInput.value);
  });

  // initialize edit UI state (in case sessionStorage kept it)
  setEditMode(songsEditMode);
</script>


    // ✅ Dynamic songs from Firestore (via your server's GET /songs)
    let SONG_LIBRARY = [];

    async function loadSongs() {
      try {
        const res = await fetch('/songs', { cache: 'no-store' });
        if (!res.ok) throw new Error(`GET /songs HTTP ${res.status}`);
        const data = await res.json();
        SONG_LIBRARY = Array.isArray(data.songs) ? data.songs : [];
        SONG_LIBRARY.sort((a, b) => a.localeCompare(b));
        console.log('[songs] loaded:', SONG_LIBRARY.length);
      } catch (e) {
        console.error('[songs] load failed:', e);
        SONG_LIBRARY = [];
      }
    }

    function setSessionHeader(text) {
      const box = document.getElementById('sessionNameBox');
      box.innerHTML = `<span class="session-title">${text}</span>`;
    }

    // -------- Song list admin gate (front-end) --------
    let adminName = localStorage.getItem('songs-admin-name') || '';

    function isAdmin() {
      const n = (adminName || '').trim().toLowerCase();
      return n === 'zaq' || n === 'zack';
    }

    function setAdminUI() {
      const badge = document.getElementById('songsAdminBadge');
      const editPanel = document.getElementById('songsEditPanel');
      if (isAdmin()) {
        badge.textContent = `Edit enabled as: ${adminName}`;
        editPanel.style.display = 'block';
      } else {
        badge.textContent = 'View only';
        editPanel.style.display = 'none';
      }
    }

    function renderSongsList(filterText='') {
      const list = document.getElementById('songsList');
      list.innerHTML = '';

      const f = (filterText || '').trim().toLowerCase();
      const songs = !f ? SONG_LIBRARY : SONG_LIBRARY.filter(s => String(s).toLowerCase().includes(f));

      songs.forEach(name => {
        const row = document.createElement('div');
        row.className = 'song-row';

        const label = document.createElement('div');
        label.className = 'song-name';
        label.textContent = name;

        row.appendChild(label);

        if (isAdmin()) {
          const del = document.createElement('button');
          del.textContent = 'Delete';
          del.className = 'btn-danger';
          del.onclick = async () => {
            if (!confirm(`Delete "${name}"?`)) return;
            const resp = await fetch(`/songs?name=${encodeURIComponent(name)}`, {
              method: 'DELETE',
              headers: { 'x-admin-name': adminName }
            });
            if (!resp.ok) {
              const err = await resp.json().catch(()=>({}));
              alert(err.error || 'Delete failed');
              return;
            }
            await loadSongs();
            renderSongsList(document.getElementById('songsSearch').value);
          };
          row.appendChild(del);
        }

        list.appendChild(row);
      });

      if (songs.length === 0) {
        const empty = document.createElement('div');
        empty.style.opacity = '.7';
        empty.style.fontSize = '.85rem';
        empty.textContent = 'No matches.';
        list.appendChild(empty);
      }
    }

    // Open/close songs overlay
    document.getElementById('songListBtn').addEventListener('click', async () => {
      document.getElementById('songsOverlay').style.display = 'flex';
      await loadSongs();
      setAdminUI();
      renderSongsList('');
      document.getElementById('songsSearch').value = '';
      document.getElementById('songsSearch').focus();
    });

    document.getElementById('songsCloseBtn').addEventListener('click', () => {
      document.getElementById('songsOverlay').style.display = 'none';
    });

    // Search within overlay
    document.getElementById('songsSearch').addEventListener('input', (e) => {
      renderSongsList(e.target.value);
    });

    // Edit gate prompt
    document.getElementById('songsEditBtn').addEventListener('click', () => {
      const val = prompt('Enter edit password (Zaq or Zack):', '') || '';
      const cleaned = val.trim();
      if (!cleaned) return;

      adminName = cleaned;
      localStorage.setItem('songs-admin-name', adminName);

      setAdminUI();
      renderSongsList(document.getElementById('songsSearch').value);
    });

    // Add song
    document.getElementById('songsAddBtn').addEventListener('click', async () => {
      const input = document.getElementById('songsAddInput');
      const name = (input.value || '').trim();
      if (!name) return;

      const resp = await fetch('/songs', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-admin-name': adminName
        },
        body: JSON.stringify({ name })
      });

      if (!resp.ok) {
        const err = await resp.json().catch(()=>({}));
        alert(err.error || 'Add failed');
        return;
      }

      input.value = '';
      await loadSongs();
      renderSongsList(document.getElementById('songsSearch').value);
    });

    // Logout edit
    document.getElementById('songsLogoutBtn').addEventListener('click', () => {
      adminName = '';
      localStorage.removeItem('songs-admin-name');
      setAdminUI();
      renderSongsList(document.getElementById('songsSearch').value);
    });

    // -------- Login + socket join --------
    async function finishLogin(name) {
      username = name.trim();
      if (!username) return;

      localStorage.setItem('setlist-username', username);
      setSessionHeader(`Session: ${sessionId} • you are ${username}`);

      document.getElementById('nameOverlay').style.display = 'none';

      // ensure songs loaded before first render
      await loadSongs();

      socket.emit('join', { sessionId, username });
    }

    if (username) {
      setSessionHeader(`Session: ${sessionId} • you are ${username}`);
      document.getElementById('nameOverlay').style.display = 'none';

      (async () => {
        await loadSongs();
        socket.emit('join', { sessionId, username });
      })();
    } else {
      const btn = document.getElementById('nameSubmit');
      const input = document.getElementById('nameInput');

      btn.addEventListener('click', () => finishLogin(input.value));
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') finishLogin(input.value);
      });
    }

    function renderGrid(session) {
      const container = document.getElementById('wordsList');
      container.innerHTML = '';

      const users = session.users || [];
      const sessionOwner = session.owner;

      users.forEach(userObj => {
        const boardUser = userObj.username;
        const isMyBoard = boardUser === username;

        const board = document.createElement('div');
        board.className = 'user-board';

        const header = document.createElement('div');
        header.className = 'user-board-header';

        const h3 = document.createElement('h3');
        h3.textContent = boardUser + (boardUser === sessionOwner ? ' (owner)' : '');
        header.appendChild(h3);

        board.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'slot-grid';

        SONG_SLOTS.forEach(slot => {
          const card = document.createElement('div');
          card.className = 'slot-card';

          const title = document.createElement('h4');
          title.textContent = slot;
          card.appendChild(title);

          const currentVal =
            session.userSongs &&
            session.userSongs[boardUser] &&
            session.userSongs[boardUser][slot];

          const value = document.createElement('div');
          value.className = 'slot-value';
          value.textContent = currentVal ? currentVal : '—';
          card.appendChild(value);

          if (isMyBoard) {
            const controlWrap = document.createElement('div');
            controlWrap.style.display = 'flex';
            controlWrap.style.flexDirection = 'column';
            controlWrap.style.gap = '.4rem';

            const isCustom = !!currentVal && !SONG_LIBRARY.includes(currentVal);

            const select = document.createElement('select');

            if (SONG_LIBRARY.length === 0) {
              const opt = document.createElement('option');
              opt.value = '';
              opt.textContent = 'No songs loaded (check /songs)';
              opt.disabled = true;
              opt.selected = true;
              select.appendChild(opt);
            } else {
              const optCustom = document.createElement('option');
              optCustom.value = '__CUSTOM__';
              optCustom.textContent = '— Type your own —';
              select.appendChild(optCustom);

              const placeholder = document.createElement('option');
              placeholder.value = '';
              placeholder.textContent = 'Choose song...';
              placeholder.disabled = true;
              select.appendChild(placeholder);

              SONG_LIBRARY.forEach(song => {
                const opt = document.createElement('option');
                opt.value = song;
                opt.textContent = song;
                select.appendChild(opt);
              });

              if (isCustom) {
                select.value = '__CUSTOM__';
              } else if (currentVal) {
                select.value = currentVal;
              } else {
                select.value = '';
              }
            }

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'inline-input';
            input.placeholder = 'Type a song...';
            input.value = isCustom ? currentVal : '';
            input.style.display = (select.value === '__CUSTOM__') ? 'block' : 'none';

            const backBtn = document.createElement('button');
            backBtn.textContent = 'Use dropdown';
            backBtn.className = 'btn-muted';
            backBtn.style.padding = '2px 6px';
            backBtn.style.fontSize = '.75rem';
            backBtn.style.width = 'fit-content';
            backBtn.style.display = (select.value === '__CUSTOM__') ? 'inline-block' : 'none';

            select.addEventListener('change', () => {
              if (select.value === '__CUSTOM__') {
                input.style.display = 'block';
                backBtn.style.display = 'inline-block';
                input.focus();
              } else if (select.value) {
                input.style.display = 'none';
                backBtn.style.display = 'none';
                socket.emit('set-song', {
                  sessionId,
                  slot,
                  value: select.value,
                  username
                });
              }
            });

            const saveCustom = () => {
              const val = input.value.trim();
              if (!val) return;
              socket.emit('set-song', { sessionId, slot, value: val, username });
            };
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveCustom(); });
            input.addEventListener('blur', saveCustom);

            backBtn.addEventListener('click', () => {
              input.style.display = 'none';
              backBtn.style.display = 'none';
              select.value = '';
              select.focus();
            });

            controlWrap.appendChild(select);
            controlWrap.appendChild(input);
            controlWrap.appendChild(backBtn);
            card.appendChild(controlWrap);
          }

          grid.appendChild(card);
        });

        board.appendChild(grid);
        container.appendChild(board);
      });
    }

    socket.on('update-session', (session) => {
      renderGrid(session);
    });

    document.getElementById('clearButton').addEventListener('click', () => {
      socket.emit('clear-all', { sessionId });
    });

    document.getElementById('refreshSongsBtn').addEventListener('click', async () => {
      await loadSongs();
      console.log('[songs] refreshed');
      alert(`Refreshed songs: ${SONG_LIBRARY.length}`);
    });

    socket.on('error', (msg) => {
      alert(msg);
    });
  </script>
</body>
</html>
