<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pigeons Playing Ping Pong Setlist Picker</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --page-bg: radial-gradient(circle at top, #0f172a 0%, #020617 55%);
      --panel: rgba(15, 23, 42, 0.55);
      --card: rgba(15, 23, 42, 0.7);
      --border: rgba(148, 163, 184, 0.25);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #22c55e;
      --danger: #ef4444;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--page-bg);
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 1.2rem;
    }
    /* top nav */
    nav {
      width: min(1100px, 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(2, 6, 23, 0.1);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      gap: .75rem;
    }
    nav a {
      color: var(--text);
      text-decoration: none;
      font-size: .8rem;
      opacity: .8;
    }
    nav a:hover {
      opacity: 1;
    }
    #sessionNameBox {
      width: min(1100px, 100%);
      background: linear-gradient(120deg, rgba(34, 197, 94, 0.35), rgba(15, 23, 42, 0.3));
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 1rem;
      padding: 0.9rem 1.1rem;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 12px 20px rgba(0, 0, 0, .15);
    }
    #values {
      width: min(1100px, 100%);
      background: rgba(2, 6, 23, 0.2);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(148, 163, 184, 0.05);
      border-radius: 1rem;
      padding: 1.3rem 1.2rem 1.5rem;
      box-shadow: 0 18px 24px rgba(0,0,0,.12);
    }
    #controlRow {
      display: flex;
      gap: .6rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      justify-content: space-between;
    }
    button {
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.35);
      color: var(--text);
      padding: .5rem .9rem;
      border-radius: .6rem;
      font-weight: 500;
      cursor: pointer;
    }
    button:hover {
      background: rgba(34, 197, 94, 0.25);
    }
    #clearButton {
      background: rgba(148, 163, 184, 0.05);
      border: 1px solid rgba(148, 163, 184, 0.16);
    }
    #wordsList {
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }
    .user-board {
      background: rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(148, 163, 184, 0.04);
      border-radius: .9rem;
      padding: .8rem .8rem 1rem;
      display: flex;
      flex-direction: column;
      gap: .8rem;
    }
    .user-board-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
    }
    .user-board-header h3 {
      margin: 0;
      font-size: .95rem;
    }
    .remove-user-btn {
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.45);
    }
    .slot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: .7rem;
    }
    .slot-card {
      background: rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(148, 163, 184, 0.08);
      border-radius: .7rem;
      padding: .5rem .5rem .7rem;
      display: flex;
      flex-direction: column;
      gap: .4rem;
      min-height: 120px;
    }
    .slot-card h4 {
      margin: 0;
      font-size: .75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    .slot-value {
      font-weight: 600;
      font-size: .9rem;
    }
    /* dark select */
    select {
      background: rgba(2, 6, 23, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.45);
      border-radius: .45rem;
      padding: .35rem .4rem;
      color: #e2e8f0;
      font-size: .8rem;
      outline: none;
    }
    select:focus {
      border-color: rgba(34, 197, 94, 0.7);
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.12);
    }
    select option {
      background: #0f172a;
      color: #e2e8f0;
    }
    /* name overlay */
    #nameOverlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.7);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .name-modal {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 1rem;
      padding: 1.4rem 1.4rem 1.1rem;
      width: min(360px, 90vw);
      text-align: center;
      box-shadow: 0 20px 45px rgba(0,0,0,.25);
    }
    .name-modal h2 {
      margin: 0 0 .5rem;
    }
    .name-modal p {
      margin: 0 0 .9rem;
      color: rgba(226, 232, 240, .6);
      font-size: .8rem;
    }
    #nameInput {
      width: 100%;
      background: rgba(2, 6, 23, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: .5rem;
      padding: .4rem .6rem;
      color: #e2e8f0;
      margin-bottom: .8rem;
    }
    #nameInput:focus {
      outline: none;
      border-color: rgba(34, 197, 94, 0.7);
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.15);
    }
    #nameSubmit {
      width: 100%;
      background: rgba(34, 197, 94, 0.25);
      border: 1px solid rgba(34, 197, 94, 0.4);
    }
    @media (max-width: 600px) {
      nav {
        flex-wrap: wrap;
        justify-content: center;
      }
      body {
        padding: .7rem;
      }
      /* add near your other input/select styles */
.inline-input {
  background: rgba(2,6,23,0.9);
  border: 1px solid rgba(148,163,184,0.45);
  border-radius: .45rem;
  padding: .35rem .4rem;
  color: #e2e8f0;
  font-size: .8rem;
  outline: none;
}
.inline-input:focus {
  border-color: rgba(34,197,94,0.7);
  box-shadow: 0 0 0 2px rgba(34,197,94,0.12);
}
    }
    /* Neon badge for the session header */
#sessionNameBox {
  border: 1px solid rgba(168, 85, 247, 0.35);
  background: linear-gradient(
    120deg,
    rgba(34, 197, 94, 0.20),
    rgba(15, 23, 42, 0.28)
  );
  box-shadow:
    0 0 10px rgba(168, 85, 247, 0.25),
    inset 0 0 12px rgba(34, 197, 94, 0.20);
}

/* Optional: a tiny glow for the actual title text inside */
#sessionNameBox .session-title {
  text-shadow:
    0 0 2px rgba(168, 85, 247, 0.35),
    0 0 5px rgba(34, 197, 94, 0.28);
}

  </style>
</head>
<body>
  <nav>
    <div>Pigeons Tour Dates - Make Your Picks!</div>
    <a href="/">Back to dates</a>
  </nav>

  <!-- dark name modal -->
  <div id="nameOverlay">
    <div class="name-modal">
      <h2>Who are you?</h2>
      <p>Enter the name you want to show on this session.</p>
      <input type="text" id="nameInput" placeholder="Andy, Zaq, etc." />
      <button id="nameSubmit">Enter</button>
    </div>
  </div>

<div id="sessionNameBox">
  <span class="session-title">Loading session…</span>
</div>

  <div id="values">
    <div id="controlRow">
      <div style="font-size:.7rem; opacity:.6;">
        Pick songs from the dropdowns — it saves automatically.
      </div>
  <button id="addSongButton">Add Song</button>
<button id="clearButton">Clear All</button>

    </div>
    <div id="wordsList"></div>
  </div>

  <script>
    const sessionId = decodeURIComponent(
      window.location.pathname.split('/').pop().trim()
    );
    const socket = io();

    // we'll set this after modal
    let username = localStorage.getItem('setlist-username');

    const SONG_SLOTS = [
      "Opener",
      "Song 2",
      "Song 3",
      "Song 4",
      "Song 5",
      "Song 6",
      "Encore",
      "Cover",
      "Bustout"
    ];

    const FALLBACK_SONG_LIBRARY= [
  "Stay", "Funk E Zekial", "Landing", "French Cafe", "Overtired", "Totally", "On the Rise", "Couldn't We All",
  "F.U.", "Melting Lights", "Julia", "Schwanthem", "Zydeko", "Time To Ride", "Sunny Day", "Moonwalk", "Horizon",
  "Lightning", "White Night", "Live Life", "Upfunk", "Live It Up", "Walk Outside", "Burning Up My Time",
  "Condenser", "Fade Fast", "Pop Off", "Bad For You", "Whoopie", "Kiwi", "Interzood", "Penguins", "Fun in Funk",
  "Somethin' for Ya", "Ocean Flows", "The Liquid", "Porcupine", "Henrietta", "Too Long", "Doc", "Fox and Toad",
  "Offshoot", "Posideon", "King Kong", "Dawn a New Day", "High as Five", "Sail On", "Avalanche", "Fortress",
  "Yo Soy Fiesta", "Overrun", "Havana", "Snake Eyes", "Skipjack", "Elephante", "Move Like That", "Lost in Line",
  "Sir Real", "Water", "Lowdown", "Su Casa", "Distant Times", "Paperboy", "Whirled", "Beanstalk", "Indiglo",
  "The Town", "Alright Tonight", "Day In Time", "My Own Way", "Fall In Place", "Skinner", "Beneath The Surface",
  "Let The Boogie Out", "Overtime", "Sorcerer", "Feelin' Fine", "Yesterday In Time", "Calm Before the Storm",
  "Underworld", "Right Track", "Hell Yeah", "In the Bubble", "Feed The Fire", "Hit the Ground Runnin'",
  "Fantasy", "Twitch", "Mine", "Donkey Hotel", "Undivided", 
   "Bloodshot Rose", "Blue Light", "Cliffs", "Dome People",
  "Drunk People", "Dutchmaster", "E Funk", "Feet on the Ground", "Funkijam", "Go With it", "J-Town",
  "Miyagi", "Montreal", "Philosophy", "Puddles", "Say Cheese", "Show Me", "Spaced", "Spacejam",
  "Steal the Shade", "The Hop", "The Labrynth", "The Switch", "The Turn", "This is that", "Treat Yourself",
  "Weightless", "Where Are We Going?", "Winters Splinters", "Wireless", "New Song"

    ].sort((a,b) => a.localeCompare(b));

    
async function loadSongsFromServer() {
  try {
    const r = await fetch('/songs', { cache: 'no-store' });
    const data = await r.json();
    const serverSongs = Array.isArray(data.songs) ? data.songs : [];

    const merged = new Set([...FALLBACK_SONG_LIBRARY, ...serverSongs]
      .map(s => String(s).trim())
      .filter(Boolean)
    );

    SONG_LIBRARY = Array.from(merged).sort((a,b)=>a.localeCompare(b));
  } catch (e) {
    SONG_LIBRARY = [...FALLBACK_SONG_LIBRARY];
  }
}
(async () => {
  await loadSongsFromServer();
})();


    function finishLogin(name) {
      username = name;
      localStorage.setItem('setlist-username', username);
      document.getElementById('sessionNameBox').textContent =
        `Session: ${sessionId} • you are ${username}`;
      document.getElementById('nameOverlay').style.display = 'none';
      socket.emit('join', { sessionId, username });
    }

    // if we already had username, skip modal
    if (username) {
      document.getElementById('sessionNameBox').textContent =
        `Session: ${sessionId} • you are ${username}`;
      document.getElementById('nameOverlay').style.display = 'none';
      socket.emit('join', { sessionId, username });
    } else {
      const btn = document.getElementById('nameSubmit');
      const input = document.getElementById('nameInput');
      btn.addEventListener('click', () => {
        const val = input.value.trim();
        if (!val) return;
        finishLogin(val);
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const val = input.value.trim();
          if (!val) return;
          finishLogin(val);
        }
      });
    }

    function renderGrid(session) {
      const container = document.getElementById('wordsList');
      container.innerHTML = '';

      const users = session.users || [];
      const sessionOwner = session.owner;

      users.forEach(userObj => {
        const boardUser = userObj.username;
        const isMyBoard = boardUser === username;
        const iAmOwner = username === sessionOwner;

        const board = document.createElement('div');
        board.className = 'user-board';

        // header
        const header = document.createElement('div');
        header.className = 'user-board-header';

        const h3 = document.createElement('h3');
        h3.textContent = boardUser + (boardUser === sessionOwner ? ' (owner)' : '');
        header.appendChild(h3);

        if (iAmOwner && boardUser !== sessionOwner) {
          const rmBtn = document.createElement('button');
          rmBtn.textContent = 'Remove user';
          rmBtn.className = 'remove-user-btn';
          rmBtn.onclick = () => {
            if (!confirm(`Remove ${boardUser}'s board from this session?`)) return;
            socket.emit('delete-user-board', {
              sessionId,
              targetUsername: boardUser
            });
          };
          header.appendChild(rmBtn);
        }

        board.appendChild(header);

        // grid
        const grid = document.createElement('div');
        grid.className = 'slot-grid';

        SONG_SLOTS.forEach(slot => {
          const card = document.createElement('div');
          card.className = 'slot-card';

          const title = document.createElement('h4');
          title.textContent = slot;
          card.appendChild(title);

          const currentVal =
            session.userSongs &&
            session.userSongs[boardUser] &&
            session.userSongs[boardUser][slot];

          const value = document.createElement('div');
          value.className = 'slot-value';
          value.textContent = currentVal ? currentVal : '—';
          card.appendChild(value);

          // only my board gets the select
   // only my board gets the picker
if (isMyBoard) {
  const controlWrap = document.createElement('div');
  controlWrap.style.display = 'flex';
  controlWrap.style.flexDirection = 'column';
  controlWrap.style.gap = '.4rem';

  // determine if currentVal is one of the library items
  const isCustom = !!currentVal && !SONG_LIBRARY.includes(currentVal);

  // SELECT (with a "Type your own" sentinel)
  const select = document.createElement('select');

  const optCustom = document.createElement('option');
  optCustom.value = '__CUSTOM__';
  optCustom.textContent = '— Type your own —';
  select.appendChild(optCustom);

  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = 'Choose song...';
  placeholder.disabled = true;
  select.appendChild(placeholder);

  SONG_LIBRARY.forEach(song => {
    const opt = document.createElement('option');
    opt.value = song;
    opt.textContent = song;
    select.appendChild(opt);
  });

  // preselect appropriately
  if (isCustom) {
    select.value = '__CUSTOM__';
  } else if (currentVal) {
    select.value = currentVal;
  } else {
    select.value = '';
  }

  // TEXT INPUT (hidden unless "__CUSTOM__" is chosen)
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Type a song...';
  input.value = isCustom ? currentVal : '';
  // dark styling to match your theme
  input.style.background = 'rgba(2,6,23,0.9)';
  input.style.border = '1px solid rgba(148,163,184,0.45)';
  input.style.borderRadius = '.45rem';
  input.style.padding = '.35rem .4rem';
  input.style.color = '#e2e8f0';
  input.style.display = (select.value === '__CUSTOM__') ? 'block' : 'none';

  // optional mini button to quickly hide the input and go back to the dropdown
  const backBtn = document.createElement('button');
  backBtn.textContent = 'Use dropdown';
  backBtn.style.background = 'rgba(148,163,184,0.05)';
  backBtn.style.border = '1px solid rgba(148,163,184,0.25)';
  backBtn.style.padding = '2px 6px';
  backBtn.style.fontSize = '.75rem';
  backBtn.style.width = 'fit-content';
  backBtn.style.display = (select.value === '__CUSTOM__') ? 'inline-block' : 'none';

  // when selection changes
  select.addEventListener('change', () => {
    if (select.value === '__CUSTOM__') {
      input.style.display = 'block';
      backBtn.style.display = 'inline-block';
      input.focus();
    } else if (select.value) {
      input.style.display = 'none';
      backBtn.style.display = 'none';
      // save immediately
      socket.emit('set-song', {
        sessionId,
        slot,
        value: select.value,
        username
      });
    }
  });

  // saving the custom text (on Enter or blur)
  const saveCustom = () => {
    const val = input.value.trim();
    if (!val) return;
    socket.emit('set-song', { sessionId, slot, value: val, username });
  };
  input.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveCustom(); });
  input.addEventListener('blur', saveCustom);

  // go back to dropdown UX
  backBtn.addEventListener('click', () => {
    input.style.display = 'none';
    backBtn.style.display = 'none';
    // keep choice open—user can pick a dropdown option next
    select.value = '';
    select.focus();
  });

  controlWrap.appendChild(select);
  controlWrap.appendChild(input);
  controlWrap.appendChild(backBtn);
  card.appendChild(controlWrap);
}




          grid.appendChild(card);
        });

        board.appendChild(grid);
        container.appendChild(board);
      });
    }

    socket.on('update-session', (session) => {
      renderGrid(session);
    });

    document.getElementById('clearButton').addEventListener('click', () => {
      socket.emit('clear-all', { sessionId });
    });

    socket.on('error', (msg) => {
      alert(msg);
    });
  </script>
</body>
</html>
